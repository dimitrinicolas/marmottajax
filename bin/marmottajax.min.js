var marmottajax=function(){if("undefined"!=typeof this.self)return new marmottajax(marmottajax.normalize(arguments));var t=marmottajax.normalize(arguments);if(null===t)throw"Les arguments passées à marmottajax sont invalides.";if(this.url=t.url,this.method=t.method,this.json=t.json,this.watch=t.watch,this.parameters=t.parameters,this.headers=t.headers,"post"===this.method||"put"===this.method||"update"===this.method||"delete"===this.method){this.postData="?";for(var e in this.parameters)this.postData+=this.parameters.hasOwnProperty(e)?"&"+e+"="+this.parameters[e]:""}else{this.url+=this.url.indexOf("?")<0?"?":"";for(var e in this.parameters)this.url+=this.parameters.hasOwnProperty(e)?"&"+e+"="+this.parameters[e]:""}this.setXhr(),this.setWatcher()};Array.prototype.contains=function(t){for(var e=this.length;e--;)if(this[e]===t)return!0;return!1},marmottajax.defaultData={method:"get",json:!1,watch:-1,parameters:{}},marmottajax.validMethods=["get","post","put","update","delete"],marmottajax.normalize=function(t){if(0===t.length)return null;var e={};return 1===t.length&&"object"==typeof t[0]?e=t[0]:1===t.length&&"string"==typeof t[0]?e={url:t[0]}:2===t.length&&"string"==typeof t[0]&&"object"==typeof t[1]&&(t[1].url=t[0],e=t[1]),e.method="string"!=typeof e.method||-1==marmottajax.validMethods.indexOf(e.method.toLowerCase())?marmottajax.defaultData.method:e.method.toLowerCase(),"boolean"!=typeof e.json&&(e.json=marmottajax.defaultData.json),"number"!=typeof e.watch&&(e.watch=marmottajax.defaultData.watch),"object"!=typeof e.parameters&&(e.parameters=marmottajax.defaultData.parameters),"object"!=typeof e.headers&&(e.headers=marmottajax.defaultData.headers),e},marmottajax.prototype.setWatcher=function(){-1!==this.watch&&(this.watchIntervalFunction=function(){4===this.xhr.readyState&&this.xhr.okStatusCodes.contains(this.xhr.status)&&this.updateXhr(),this.watcherTimeout()},this.watcherTimeout(),this.stop=function(){this.changeTime(-1)},this.changeTime=function(t){clearTimeout(this.changeTimeout),this.watch="number"==typeof t?t:this.watch,this.watcherTimeout()})},marmottajax.prototype.setXhr=function(){this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.lastResult=null,this.xhr.json=this.json,this.xhr.binding=null,this.xhr.okStatusCodes=[200,201,202,203,204,205,206],this.bind=function(t){return this.xhr.binding=t,this},this.cancel=function(t){return this.xhr.abort(),this},this.xhr.callbacks={then:[],change:[],error:[]};for(var t in this.xhr.callbacks)this.xhr.callbacks.hasOwnProperty(t)&&(this[t]=function(t){return function(e){return this.xhr.callbacks[t].push(e),this}}(t));if(this.xhr.call=function(t,e){for(var s=0;s<this.callbacks[t].length;s++)"function"==typeof this.callbacks[t][s]&&(this.binding?this.callbacks[t][s].call(this.binding,e):this.callbacks[t][s](e))},this.xhr.onreadystatechange=function(){if(4===this.readyState&&this.xhr.okStatusCodes.contains(this.status)){var t=this.responseText;if(this.json)try{t=JSON.parse(t)}catch(e){return this.call("error","invalid json"),!1}this.lastResult=t,this.call("then",t)}else 4===this.readyState&&404==this.status?this.call("error","404"):4===this.readyState&&this.call("error","unknow")},this.xhr.open(this.method,this.url,!0),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.headers)for(header in this.headers)this.headers.hasOwnProperty(header)&&this.xhr.setRequestHeader(header,this.headers[header]);this.xhr.send("undefined"!=typeof this.postData?this.postData:null)},marmottajax.prototype.updateXhr=function(){var t={lastResult:this.xhr.lastResult,json:this.xhr.json,binding:this.xhr.binding,callbacks:{then:this.xhr.callbacks.then,change:this.xhr.callbacks.change,error:this.xhr.callbacks.error}};this.xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),this.xhr.lastResult=t.lastResult,this.xhr.json=t.json,this.xhr.binding=t.binding,this.xhr.callbacks={then:t.callbacks.then,change:t.callbacks.change,error:t.callbacks.error},this.xhr.call=function(t,e){for(var s=0;s<this.callbacks[t].length;s++)"function"==typeof this.callbacks[t][s]&&(this.binding?this.callbacks[t][s].call(this.binding,e):this.callbacks[t][s](e))},this.xhr.onreadystatechange=function(){if(4===this.readyState&&this.xhr.okStatusCodes.contains(this.status)){var t=this.responseText;if(this.json)try{t=JSON.parse(t)}catch(e){return this.call("error","invalid json"),!1}isDifferent=this.lastResult!=t;try{isDifferent=("string"!=typeof this.lastResult?JSON.stringify(this.lastResult):this.lastResult)!=("string"!=typeof t?JSON.stringify(t):t)}catch(e){}isDifferent&&this.call("change",t),this.lastResult=t}else 4===this.readyState&&404==this.status?this.call("error","404"):4===this.readyState&&this.call("error","unknow")},this.xhr.open(this.method,this.url,!0),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.send("undefined"!=typeof postData?postData:null)},marmottajax.prototype.watcherTimeout=function(){-1!==this.watch&&(this.changeTimeout=setTimeout(function(t){return function(){t.watchIntervalFunction()}}(this),this.watch))};